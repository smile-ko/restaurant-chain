<div class="content_container">
  <div class="table">
    <div class="table_head">
      <div class="table_title">
        <h1>Sản phẩm</h1>
      </div>
      <div class="table_action">
        <ul class="table_tab">
          <li class="active"><a href="#">Danh sách</a></li>
        </ul>
        <div class="table_totalItem">
          Tổng: <b id="total_item">0</b> Sản phẩm
        </div>
      </div>
    </div>
    <div class="table_main animation" id="table_main">
      <div class="table_loader">
        <div class="loader"></div>
      </div>
      <div class="top_table">
        <div class="table_right">
          <div class="table_search">
            <input id="search" type="text" placeholder="Tìm kiếm..." />
            <i class="fa-solid fa-magnifying-glass"></i>
          </div>
        </div>
        <div class="table_left">
          <button
            class="modal-open btn btn_primary table_add"
            data-modal-target="#create-modal"
          >
            Thêm mới
          </button>
        </div>
      </div>
      <div class="table_content">
        <!-- Table root -->
        <table id="table"></table>
      </div>
    </div>
  </div>
</div>
<style>
  .btn_cancel,
  .btn_show,
  .btn_confirm {
    display: none;
  }
</style>
<!-- Modal Create -->
<div id="create-modal" class="modal">
  <div class="modal_container">
    <button class="modal_close btn-close">
      <i class="fa-solid fa-xmark"></i>
    </button>
    <div class="modal_inner">
      <h1 class="modal_title">Thêm sản phẩm</h1>
      <form class="form mt-5" id="form_create" style="width: 700px">
        <div class="form_group">
          <div class="form_field">
            <input
              name="title"
              id="title"
              type="text"
              class="form_input"
              placeholder=" "
              autocomplete="off"
            />
            <label for="title" class="form_label">Tên sản phẩm</label>
          </div>
          <span class="form_messages"></span>
        </div>

        <div class="form_group">
          <div class="form_field">
            <input
              name="price"
              id="price"
              type="number"
              class="form_input"
              placeholder=" "
              autocomplete="off"
            />
            <label for="price" class="form_label">Giá</label>
          </div>
          <span class="form_messages"></span>
        </div>

        <div class="form_group">
          <div class="form_field">
            <select name="categoryId" id="categoryId" class="form_input">
              <option value="" disabled selected hidden>-- Chọn --</option>
            </select>
            <label for="categoryId" class="form_label">Danh mục</label>
          </div>
          <span class="form_messages"></span>
        </div>

        <div class="form_group">
          <div class="form_field">
            <textarea
              name="description"
              id="description"
              class="form_input"
              placeholder=" "
              autocomplete="off"
            ></textarea>
            <label for="description" class="form_label">Mô tả sản phẩm</label>
          </div>
          <span class="form_messages"></span>
        </div>

        <div class="form_group">
          <div class="form_field">
            <input name="image" id="image" type="file" class="form_input" />
            <label for="image" class="form_label">Hình ảnh</label>
          </div>
          <span class="form_messages"></span>
        </div>

        <div class="form_action text-right">
          <div class="btn btn_secondary modal_close">Huỷ</div>
          <button type="submit" class="btn btn_primary">Thêm</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- /Modal Create -->

<!-- Modal Edit -->
<div id="edit-modal" class="modal">
  <div class="modal_container">
    <button class="modal_close btn-close">
      <i class="fa-solid fa-xmark"></i>
    </button>
    <div class="modal_inner">
      <h1 class="modal_title">Cập nhật sản phẩm</h1>
      <form
        class="form mt-5"
        id="form_edit"
        style="width: 700px"
        enctype="multipart/form-data"
      >
        <div class="form_group" style="display: none">
          <div class="form_field">
            <input name="id" id="edit_id" type="text" class="form_input" />
          </div>
        </div>

        <div class="form_group">
          <div class="form_field">
            <input
              name="title"
              id="edit_title"
              type="text"
              class="form_input"
              placeholder=" "
              autocomplete="off"
            />
            <label for="edit_title" class="form_label">Tên sản phẩm</label>
          </div>
          <span class="form_messages"></span>
        </div>

        <div class="form_group">
          <div class="form_field">
            <input
              name="price"
              id="edit_price"
              type="number"
              class="form_input"
              placeholder=" "
              autocomplete="off"
            />
            <label for="edit_price" class="form_label">Giá</label>
          </div>
          <span class="form_messages"></span>
        </div>
        <div class="form_group">
          <div class="form_field">
            <textarea
              name="description"
              id="edit_description"
              type="text"
              class="form_input"
              placeholder=" "
              autocomplete="off"
            ></textarea>
            <label for="description" class="form_label">Mô tả sản phẩm</label>
          </div>
          <span class="form_messages"></span>
        </div>
        <div class="form_group">
          <div class="form_field">
            <select name="categoryId" id="edit_categoryId" class="form_input">
              <option value="" disabled selected hidden>-- Chọn --</option>
            </select>
            <label for="edit_categoryId" class="form_label">Danh mục</label>
          </div>
          <span class="form_messages"></span>
        </div>
        <div class="form_group">
          <div class="form_field">
            <select name="status" id="edit_status" class="form_input">
              <option value="còn">Sẵn sàng</option>
              <option value="hết">Hết</option>
            </select>
            <label for="edit_status" class="form_label">Trạng thái</label>
          </div>
          <span class="form_messages"></span>
        </div>

        <div class="form_group">
          <div class="form_field">
            <input
              name="image"
              id="edit_image"
              type="file"
              class="form_input"
            />
            <label for="edit_image" class="form_label">Hình ảnh</label>
          </div>
          <span class="form_messages"></span>
        </div>

        <div id="image-preview"></div>

        <div class="form_action text-right">
          <div class="btn btn_secondary modal_close">Huỷ</div>
          <button type="submit" class="btn btn_primary">Cập nhật</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- /Modal Edit -->

<!-- Modal delete -->
<div id="delete-modal" class="modal">
  <div class="modal_container">
    <button class="modal_close btn-close">
      <i class="fa-solid fa-xmark"></i>
    </button>
    <div class="modal_inner">
      <h1 class="modal_title">Xoá sản phẩm</h1>
      <div class="form mt-5" id="form_delete" style="width: 450px">
        <h1>Bạn có chắc muốn xoá sản phẩm này?</h1>
        <div class="form_action text-right mt-5">
          <div class="btn btn_secondary modal_close">Huỷ</div>
          <button type="submit" class="btn btn_primary">Xác nhận</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- /Modal delete -->

<script src="/admins/js/table.js"></script>
<script src="/admins/js/toast.js"></script>
<script src="/admins/js/validator.js"></script>

<script>
  const columns = [
    { title: "#", field: "index", width: "100px" },
    { title: "Tên sản phẩm", field: "title", width: "200px" },
    { title: "Giá", field: "price", type: "format", align: "center" },
    { title: "Danh mục", field: "categoryTitle", align: "center" },
    { title: "Trạng thái", field: "statusProduct", align: "center" },
    {
      title: "Hình ảnh",
      field: "image",
      type: "img",
      align: "center",
    },
  ];

  const init = () => {
    $.ajax({
      type: "GET",
      url: "foods/all",
      success: function (response) {
        const products = response.data;
        renderTable(products, columns, true);
        searchTable(products, "#search", columns, true);
        $("#table_main").removeClass("animation");
      },
      error: function (error) {
        toast({
          title: "Tải trang thất bại",
          message: `Lỗi máy chủ`,
          type: "error",
          duration: 3000,
        });
      },
    });

    // Fetch categories and populate select input
    $.ajax({
      type: "GET",
      url: "categories/all",
      success: function (response) {
        const categories = response.data;
        populateSelect("#categoryId", categories);
        populateSelect("#edit_categoryId", categories);
      },
      error: function (error) {
        toast({
          title: "Tải danh sách danh mục thất bại",
          message: `Lỗi máy chủ`,
          type: "error",
          duration: 3000,
        });
      },
    });
  };

  // Helper function to populate select inputs
  function populateSelect(selectId, data) {
    const select = $(selectId);
    select.empty(); // Clear existing options
    select.append(
      '<option value="" disabled selected hidden>-- Chọn --</option>'
    );
    data.forEach((item) => {
      const option = $("<option></option>")
        .attr("value", item.id)
        .text(item.title);
      select.append(option);
    });
  }

  init();

  // Handle edit
  const handleEdit = (id) => {
    $("#edit-modal").addClass("show");
    $("#image-preview").html(""); // Xóa ảnh xem trước
    $.ajax({
      type: "GET",
      url: `foods/${id}`,
      success: function (response) {
        const product = response.data;
        $("#form_edit #edit_id").val(product.id);
        $("#form_edit #edit_title").val(product.title);
        $("#form_edit #edit_price").val(product.price);
        $("#form_edit #edit_status").val(product.statusProduct);
        $("#form_edit #edit_description").val(product.description);
        $("#form_edit #edit_categoryId").val(product.categoryId);
        // Hiển thị ảnh hiện tại
        if (product.image) {
          $("#image-preview").html(
            `<img src="/storages_image/${product.image}" alt="Current Image" style="max-width: 200px;">`
          );
        }
      },
      error: function (error) {
        toast({
          title: "Thất bại",
          message: `Lỗi hệ thống`,
          type: "error",
          duration: 3000,
        });
      },
    });
  };

  const handleDelete = (id) => {
    $("#delete-modal").addClass("show");
    $("#delete-modal .btn_primary").data("id", id);
  };

  // Handle click btn delete
  $("#delete-modal .btn_primary").on("click", function () {
    $("#delete-modal").removeClass("show");
    $("#table_main").addClass("animation");
    const id = $(this).data("id");

    $.ajax({
      type: "DELETE",
      url: `foods/${id}`,
      success: function (response) {
        init();
        toast({
          title: "Thành công",
          message: `Xoá sản phẩm thành công`,
          type: "success",
          duration: 3000,
        });
      },
      error: function (error) {
        toast({
          title: "Thất bại",
          message: `Lỗi hệ thống`,
          type: "error",
          duration: 3000,
        });
      },
    });
  });

  // Handle validation form create
  Validator({
    form: "#form_create",
    formGroupSelector: ".form_group",
    errorSelector: ".form_messages",
    rules: [
      Validator.isRequired("#title", "Vui lòng nhập tên sản phẩm."),
      Validator.isRequired("#price", "Vui lòng nhập giá sản phẩm"),
      Validator.isRequired("#description", "Vui lòng nhập mô tả sản phẩm"),
      Validator.isRequired("#categoryId", "Vui lòng chọn danh mục"),
      Validator.isRequired("#image", "Vui lòng chọn hình ảnh sản phẩm"),
    ],
    onSubmit: function (data) {
      $("#create-modal").removeClass("show");
      $("#table_main").addClass("animation");

      var formData = new FormData();
      formData.append("title", data.title);
      formData.append("price", data.price);
      formData.append("description", data.description);
      formData.append("categoryId", data.categoryId);
      formData.append("image", data.image);

      $.ajax({
        type: "POST",
        url: "foods/",
        data: formData,
        cache: false,
        processData: false,
        contentType: false,
        success: function (response) {
          if (response.code === 0) {
            toast({
              title: "Thành công",
              message: `Thêm sản phẩm thành công`,
              type: "success",
              duration: 3000,
            });
          } else {
            toast({
              title: "Thất bại",
              message: response.message,
              type: "error",
              duration: 3000,
            });
          }
          init();
        },
        error: function (error) {
          console.error("Error:", error);
          toast({
            title: "Thất bại",
            message: `Thêm sản phẩm thất bại`,
            type: "error",
            duration: 3000,
          });
        },
      });
    },
  });

  // Handle validation form edit
  Validator({
    form: "#form_edit",
    formGroupSelector: ".form_group",
    errorSelector: ".form_messages",
    rules: [
      Validator.isRequired("#edit_title", "Vui lòng nhập tên sản phẩm."),
      Validator.isRequired("#edit_price", "Vui lòng nhập giá sản phẩm"),
      Validator.isRequired("#edit_categoryId", "Vui lòng chọn danh mục"),
    ],
    onSubmit: function (data) {
      const { id, ...restData } = data;
      $("#edit-modal").removeClass("show");
      $("#table_main").addClass("animation");

      var formData = new FormData();
      for (var key in restData) {
        formData.append(key, restData[key]);
      }

      $.ajax({
        type: "PUT",
        url: `foods/${id}`,
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          if (response.code === 0) {
            toast({
              title: "Thành công",
              message: `Cập nhật sản phẩm thành công`,
              type: "success",
              duration: 3000,
            });
          } else {
            toast({
              title: "Thất bại",
              message: response.message,
              type: "error",
              duration: 3000,
            });
          }
          init();
        },
        error: function (error) {
          toast({
            title: "Thất bại",
            message: `Cập nhật sản phẩm thất bại`,
            type: "error",
            duration: 3000,
          });
        },
      });
    },
  });
</script>
