<div class="content_container">
  <div class="table">
    <div class="table_head">
      <div class="table_title">
        <h1>Khách hàng</h1>
      </div>
      <div class="table_action">
        <ul class="table_tab">
          <li class="active"><a href="#">Danh sách</a></li>
        </ul>
        <div class="table_totalItem">
          Tổng: <b id="total_item">0</b> Khách hàng
        </div>
      </div>
    </div>
    <div class="table_main animation" id="table_main">
      <div class="table_loader">
        <div class="loader"></div>
      </div>
      <div class="top_table">
        <div class="table_right">
          <div class="table_search">
            <input id="search" type="text" placeholder="Tìm kiếm..." />
            <i class="fa-solid fa-magnifying-glass"></i>
          </div>
        </div>
        <div class="table_left">
          <button
            class="modal-open btn btn_primary table_add"
            data-modal-target="#create-modal"
          >
            Thêm mới
          </button>
        </div>
      </div>
      <div class="table_content">
        <!-- Table root -->
        <table id="table"></table>
      </div>
    </div>
  </div>
</div>
<style>
  .btn_cancel,
  .btn_confirm {
    display: none;
  }
</style>
<!-- Modal Create -->
<div id="create-modal" class="modal">
  <div class="modal_container">
    <button class="modal_close btn-close">
      <i class="fa-solid fa-xmark"></i>
    </button>
    <div class="modal_inner">
      <h1 class="modal_title">Thêm Khách hàng</h1>
      <form class="form mt-5" id="form_create" style="width: 700px">
        <div class="form_group">
          <div class="form_field">
            <input
              name="fullName"
              id="fullName"
              type="text"
              class="form_input"
              placeholder=" "
              autocomplete="off"
            />
            <label for="fullName" class="form_label">Họ và tên</label>
          </div>
          <span class="form_messages"></span>
        </div>
        <div class="form_group">
          <div class="form_field">
            <input
              name="phoneNumber"
              id="phoneNumber"
              type="text"
              class="form_input"
              placeholder=" "
              autocomplete="off"
            />
            <label for="phoneNumber" class="form_label">Số điện thoại</label>
          </div>
          <span class="form_messages"></span>
        </div>

        <div class="form_group">
          <div class="form_field">
            <input
              name="email"
              id="email"
              type="email"
              class="form_input"
              placeholder=" "
              autocomplete="off"
            />
            <label for="email" class="form_label">Email</label>
          </div>
          <span class="form_messages"></span>
        </div>

        <div class="form_group">
          <div class="form_field">
            <select name="gender" id="gender" class="form_input">
              <option value="" disabled selected hidden>-- Chọn --</option>
              <option value="1">Nam</option>
              <option value="0">Nữ</option>
            </select>
            <label for="gender" class="form_label">Giới tính</label>
          </div>
          <span class="form_messages"></span>
        </div>

        <div class="form_group">
          <div class="form_field">
            <input
              name="dob"
              id="dob"
              type="date"
              class="form_input"
              placeholder=" "
              autocomplete="off"
            />
            <label for="dob" class="form_label">Ngày sinh</label>
          </div>
          <span class="form_messages"></span>
        </div>

        <!-- <div class="form_group">
                    <div class="form_field">
                        <input
                            name="password"
                            id="password"
                            type="password"
                            class="form_input"
                            placeholder=" "
                            autocomplete="off"
                        />
                        <label for="password" class="form_label"
                            >Mật khẩu</label
                        >
                    </div>
                    <span class="form_messages"></span>
                </div> -->

        <div class="form_action text-right">
          <div class="btn btn_secondary modal_close">Huỷ</div>
          <button type="submit" class="btn btn_primary">Thêm</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- /Modal Create -->

<!-- Modal Edit -->
<div id="edit-modal" class="modal">
  <div class="modal_container">
    <button class="modal_close btn-close">
      <i class="fa-solid fa-xmark"></i>
    </button>
    <div class="modal_inner">
      <h1 class="modal_title">Cập nhật Khách hàng</h1>
      <form class="form mt-5" id="form_edit" style="width: 700px">
        <div class="form_group" style="display: none">
          <div class="form_field">
            <input name="id" id="id" type="text" class="form_input" />
          </div>
        </div>
        <div class="form_group">
          <div class="form_field">
            <input
              name="fullName"
              id="edit_fullName"
              type="text"
              class="form_input"
              placeholder=" "
              autocomplete="off"
            />
            <label for="edit_fullName" class="form_label">Họ và tên</label>
          </div>
          <span class="form_messages"></span>
        </div>

        <div class="form_group">
          <div class="form_field">
            <input
              name="phoneNumber"
              id="edit_phoneNumber"
              type="text"
              class="form_input"
              placeholder=" "
              autocomplete="off"
            />
            <label for="edit_phoneNumber" class="form_label"
              >Số điện thoại</label
            >
          </div>
          <span class="form_messages"></span>
        </div>

        <div class="form_group">
          <div class="form_field">
            <input
              name="email"
              id="edit_email"
              type="email"
              class="form_input"
              placeholder=" "
              autocomplete="off"
            />
            <label for="edit_email" class="form_label">Email</label>
          </div>
          <span class="form_messages"></span>
        </div>

        <div class="form_group">
          <div class="form_field">
            <select name="gender" id="edit_gender" class="form_input">
              <option value="" disabled selected hidden>-- Chọn --</option>
              <option value="true">Nam</option>
              <option value="false">Nữ</option>
            </select>
            <label for="edit_gender" class="form_label">Giới tính</label>
          </div>
          <span class="form_messages"></span>
        </div>

        <div class="form_group">
          <div class="form_field">
            <input
              name="dob"
              id="edit_dob"
              type="date"
              class="form_input"
              placeholder=" "
              autocomplete="off"
            />
            <label for="edit_dob" class="form_label">Ngày sinh</label>
          </div>
          <span class="form_messages"></span>
        </div>

        <div class="form_action text-right">
          <div class="btn btn_secondary modal_close">Huỷ</div>
          <button type="submit" class="btn btn_primary">Cập nhật</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- /Modal Edit-->

<!-- Modal delete -->
<div id="delete-modal" class="modal">
  <div class="modal_container">
    <button class="modal_close btn-close">
      <i class="fa-solid fa-xmark"></i>
    </button>
    <div class="modal_inner">
      <h1 class="modal_title">Xoá Khách hàng</h1>
      <div class="form mt-5" id="form_delete" style="width: 450px">
        <h1>Bạn có chắc muốn xoá Khách hàng này?</h1>
        <div class="form_action text-right mt-5">
          <div class="btn btn_secondary modal_close">Huỷ</div>
          <button type="submit" class="btn btn_primary">Xác nhận</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- /Modal delete -->

<!-- Modal show -->
<div id="show-modal" class="modal">
  <div class="modal_container">
    <button class="modal_close btn-close">
      <i class="fa-solid fa-xmark"></i>
    </button>
    <div class="modal_inner">
      <h1 class="modal_title">
        Lịch sử của khách hàng: <span id="full_name"></span>
      </h1>
      <div
        class="form_container"
        style="display: flex; width: 900px; max-height: inset"
      >
        <div class="modal-show-store" style="width: 100%">
          <div
            class="mt-4"
            style="overflow: auto; max-height: calc(100vh - 310px)"
          >
            <table id="table-mini"></table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- /Modal show-->

<script src="/admins/js/table.js"></script>
<script src="/admins/js/toast.js"></script>
<script src="/admins/js/validator.js"></script>
<script src="/admins/js/utils.js"></script>
<script src="/admins/js/table-mini.js"></script>

<script>
  const columns = [
    { title: "#", field: "index", width: "100px" },
    { title: "Họ và tên", field: "fullName" },
    { title: "Số điện thoại", field: "phoneNumber", align: "center" },
    { title: "Email", field: "email", width: "200px" },
    {
      title: "Điểm tích lũy",
      field: "pointMemberValue",
      width: "200px",
      align: "center",
    },
    {
      title: "Giới tính",
      field: "gender",
      filter: [{ true: "Nam" }, { false: "Nữ" }],
      align: "center",
    },
    {
      title: "Ngày sinh",
      field: "dob",
      align: "center",
    },
  ];

  const columns_table_mini = [
    { title: "#", field: "index", width: "100px" },
    { title: "Mã hóa đơn", field: "id", align: "center" },
    {
      title: "Số bàn",
      field: "tableNumber",
      align: "center",
    },
    {
      title: "Tổng tiền",
      field: "totalPrice",
      type: "format",
      align: "center",
    },
    {
      title: "Phương thức thanh toán",
      field: "paymentMethod",
      align: "center",
    },
    {
      title: "Trạng thái",
      field: "statusPay",
      align: "center",
    },
    {
      title: "Ngày thanh toán",
      field: "updatedAt",
      type: "date",
      align: "center",
    },
  ];

  const init = () => {
    $.ajax({
      type: "GET",
      url: "customers/all",
      success: function (response) {
        const users = response.data;

        // Init table
        renderTable(users, columns, true);

        // Handle search
        searchTable(users, "#search", columns, true);

        $("#table_main").removeClass("animation");
      },
      error: function (error) {
        toast({
          title: "Tải trang thất bại",
          message: `Lỗi máy chủ`,
          type: "error",
          duration: 3000,
        });
      },
    });
  };

  init();

  // Handle edit
  const handleEdit = (id) => {
    $("#edit-modal").addClass("show");
    $.ajax({
      type: "GET",
      url: `customers/${id}`,
      success: function (response) {
        const user = response.data;

        $("#form_edit #id").val(user.id);
        $("#form_edit #edit_fullName").val(user.fullName);
        $("#form_edit #edit_phoneNumber").val(user.phoneNumber);
        $("#form_edit #edit_email").val(user.email);
        $("#form_edit #edit_gender").val(user.gender.toString());
        $("#form_edit #edit_dob").val(formatDate(user.dob));
      },
      error: function (error) {
        toast({
          title: "Thất bại",
          message: `Lỗi hệ thống`,
          type: "error",
          duration: 3000,
        });
      },
    });
  };

  // Handle delete
  const handleDelete = (id) => {
    $("#delete-modal").addClass("show");
    $("#delete-modal .btn_primary").data("id", id);
  };

  // Handle click btn delete
  $("#delete-modal .btn_primary").on("click", function () {
    $("#delete-modal").removeClass("show");
    $("#table_main").addClass("animation");
    const id = $(this).data("id");

    $.ajax({
      type: "DELETE",
      url: `customers/${id}`,
      success: function (response) {
        init();
        toast({
          title: "Thành công",
          message: `Xóa Khách hàng thành công`,
          type: "success",
          duration: 3000,
        });
      },
      error: function (error) {
        toast({
          title: "Thất bại",
          message: `Lỗi hệ thống`,
          type: "error",
          duration: 3000,
        });
      },
    });
  });

  // Handle validation form create
  Validator({
    form: "#form_create",
    formGroupSelector: ".form_group",
    errorSelector: ".form_messages",
    rules: [
      Validator.isRequired("#fullName", "Vui lòng nhập họ và tên."),
      Validator.isRequired("#phoneNumber", "Vui lòng nhập số điện thoại."),
      // Validator.isRequired("#email", "Vui lòng nhập email."),
      Validator.isRequired("#gender", "Vui lòng chọn giới tính."),
      // Validator.isRequired("#dob", "Vui lòng nhập ngày sinh."),
      // Validator.isRequired('#password', 'Vui lòng nhập mật khẩu.'),
      // Validator.minLength(
      //     '#password',
      //     6,
      //     'Mật khẩu yêu cầu ít nhất 6 ký tự'
      // ),
      // Validator.isEmail("#email", "Vui lòng nhập email hợp lệ."),
    ],
    onSubmit: (data) => {
      $("#create-modal").removeClass("show");
      $("#table_main").addClass("animation");

      $.ajax({
        type: "POST",
        url: "customers",
        data: data,
        success: function (response) {
          if (response.code === 0) {
            toast({
              title: "Thành công",
              message: `Thêm Khách hàng thành công`,
              type: "success",
              duration: 3000,
            });
          } else {
            toast({
              title: "Thất bại",
              message: response.message,
              type: "error",
              duration: 3000,
            });
          }
          init();
        },
        error: function (error) {
          toast({
            title: "Thất bại",
            message: `Thêm Khách hàng thất bại`,
            type: "error",
            duration: 3000,
          });
        },
      });
    },
  });

  // Handle validation form edit
  Validator({
    form: "#form_edit",
    formGroupSelector: ".form_group",
    errorSelector: ".form_messages",
    rules: [
      Validator.isRequired("#edit_fullName", "Vui lòng nhập họ và tên."),
      Validator.isRequired("#edit_email", "Vui lòng nhập email."),
      Validator.isRequired("#edit_gender", "Vui lòng chọn giới tính."),
      Validator.isRequired("#edit_dob", "Vui lòng nhập ngày sinh."),
      Validator.isEmail("#edit_email", "Vui lòng nhập email hợp lệ."),
    ],
    onSubmit: (data) => {
      const { id, ...restData } = data;
      $("#edit-modal").removeClass("show");
      $("#table_main").addClass("animation");

      $.ajax({
        type: "PUT",
        url: `customers/${id}`,
        data: restData,
        success: function (response) {
          if (response.code === 0) {
            toast({
              title: "Thành công",
              message: `Cập nhật Khách hàng thành công`,
              type: "success",
              duration: 3000,
            });
          } else {
            toast({
              title: "Thất bại",
              message: response.message,
              type: "error",
              duration: 3000,
            });
          }

          init();
        },
        error: function (error) {
          toast({
            title: "Thất bại",
            message: `Cập nhật Khách hàng thất bại`,
            type: "error",
            duration: 3000,
          });
        },
      });
    },
  });

  //   Handle Show
  const handleShow = (id) => {
    $.ajax({
      url: `/admin/customers/get-order-history/${id}`,
      method: "GET",
      success: (response) => {
        if (response.code === 1 || response.data.orders.length === 0) {
          toast({
            title: "Không có thông tin",
            message: `Chưa có thông tin hóa đơn cho khách hàng này.`,
            type: "waning",
            duration: 3000,
          });

          return;
        }

        $("#show-modal").addClass("show");
        $("#full_name").text(response.data.user.fullName);
        renderTable_mini(response.data.orders, columns_table_mini, false);
      },
      error: () => {
        toast({
          title: "Thất bại",
          message: `Lấy thông tin Khách hàng thất bại`,
          type: "error",
          duration: 3000,
        });
      },
    });
  };
</script>
